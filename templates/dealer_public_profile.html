{% extends 'base.html' %}
{% load static %}
{% block content %}

<section class="container mt-5">

  <!-- ===== HERO ===== -->
  <div class="dealer-hero"
       style="background-image:url('{% if profile.banner %}{{ profile.banner.url }}{% else %}{% static 'images/dealer-banner.jpg' %}{% endif %}')">

    <div class="dealer-hero-overlay text-center">
      {% if profile.logo %}
        <img src="{{ profile.logo.url }}" class="dealer-logo mb-3">
      {% endif %}
      <h1>{{ profile.company_name }}</h1>
      <p>{{ profile.about }}</p>
    </div>
  </div>

  <!-- ===== DEALER INFO ===== -->
  <div class="card p-4 shadow-sm my-5">
    <h2 class="fw-bold">{{ profile.company_name }}</h2>
    <p class="text-muted">{{ profile.about }}</p>

    <div class="d-flex gap-4 mt-3 flex-wrap">
      <span>‚≠ê {{ avg_rating|default:"No ratings yet" }}</span>
      <span>üöó {{ cars.count }} Cars Listed</span>
    </div>

    {% if profile.is_verified %}
      <span class="badge bg-success mt-3">Verified Dealer</span>
    {% else %}
      <span class="badge bg-secondary mt-3">Unverified Dealer</span>
    {% endif %}
  </div>

  <!-- ===== AVAILABLE CARS ===== -->
  <h4 class="mb-3">Available Cars</h4>
  <div class="row">
    {% for car in cars %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
          <img src="{% if car.main_image %}{{ car.main_image.url }}{% else %}{% static 'images/car-placeholder.jpg' %}{% endif %}"
               class="card-img-top">
          <div class="card-body">
            <h5>{{ car.title }}</h5>
            <p class="text-muted">{{ car.brand }} ‚Ä¢ {{ car.year }}</p>
            <p class="fw-bold">‚Çπ {{ car.price }}</p>
            <a href="{% url 'car_detail' car.id %}" class="btn btn-outline-dark w-100">
              View
            </a>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No cars available.</p>
    {% endfor %}
  </div>

  <!-- ===== REVIEWS ===== -->
   <!-- ===== REVIEWS ===== -->
<h4 class="mt-5">Customer Reviews</h4>

{% if reviews %}
  {% for review in reviews %}
    <div class="border-bottom py-3">

      <strong>{{ review.user.username }}</strong>
      <span class="text-warning ms-2">
        {{ review.rating }} ‚òÖ
      </span>

      <p class="mb-1">{{ review.comment }}</p>
      <small class="text-muted">
        {{ review.created_at|date:"M d, Y" }}
      </small>

      <!-- DEALER REPLY DISPLAY -->
      {% if review.dealer_reply %}
        <div class="bg-light p-3 rounded mt-2 ms-4">
          <strong>Dealer Reply:</strong>
          <p class="mb-0">{{ review.dealer_reply }}</p>
        </div>
      {% endif %}

      <!-- DEALER REPLY FORM (ONLY DEALER SEES THIS) -->
      {% if user.is_authenticated and user == dealer and not review.dealer_reply %}
        <form method="post"
              action="{% url 'reply_to_review' review.id %}"
              class="mt-3 ms-4">
          {% csrf_token %}
          <textarea name="reply"
                    class="form-control mb-2"
                    rows="2"
                    placeholder="Reply to this review"></textarea>
          <button class="btn btn-sm btn-outline-primary">
            Reply
          </button>
        </form>
      {% endif %}

    </div>
  {% endfor %}
{% else %}
  <p class="text-muted">
    This dealer has not received any reviews yet.
  </p>
{% endif %}

  <!-- ===== ADD REVIEW (CUSTOMER ONLY) ===== -->
  {% if can_review %}
  <div class="card mt-5 p-4">
    <h5>Leave a Review</h5>
    <form method="post" action="{% url 'add_dealer_review' dealer.username %}">
      {% csrf_token %}
      {{ review_form.as_p }}
      <button class="btn btn-primary">Submit Review</button>
    </form>
  </div>
  {% endif %}

</section>

{% endblock %}
